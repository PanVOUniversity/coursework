#!/bin/bash
# Автоматизация настройки Linux сервера для обучения с Docker и GPU
# Использование: вставить в "User data" при создании сервера

set -e  # Остановка при ошибке

echo "=========================================="
echo "Настройка сервера для обучения"
echo "=========================================="

# Обновление системы
echo "Обновление системы..."
export DEBIAN_FRONTEND=noninteractive
apt-get update
apt-get upgrade -y

# Установка базовых утилит
echo "Установка базовых утилит..."
apt-get install -y \
    curl \
    wget \
    git \
    vim \
    htop \
    screen \
    tmux \
    build-essential \
    ca-certificates \
    gnupg \
    lsb-release

# Настройка SSH ключа
echo "Настройка SSH ключа..."
mkdir -p /home/ubuntu/.ssh
chmod 700 /home/ubuntu/.ssh
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFTOpsjzuBFCbfirtXmRuUpOdG5YnE+z+PVoKETeXZ7v panvo@Vladimir" >> /home/ubuntu/.ssh/authorized_keys
chmod 600 /home/ubuntu/.ssh/authorized_keys
chown -R ubuntu:ubuntu /home/ubuntu/.ssh

# Установка Docker
echo "Установка Docker..."
if ! command -v docker &> /dev/null; then
    # Добавление репозитория Docker
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
    
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    apt-get update
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    
    # Добавление пользователя ubuntu в группу docker
    usermod -aG docker ubuntu
    
    # Запуск Docker
    systemctl enable docker
    systemctl start docker
    echo "Docker установлен и запущен"
else
    echo "Docker уже установлен"
fi

# Установка NVIDIA Container Toolkit
echo "Установка NVIDIA Container Toolkit..."
if command -v nvidia-smi &> /dev/null; then
    distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list | \
        sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
        tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
    
    apt-get update
    apt-get install -y nvidia-container-toolkit
    
    # Настройка Docker для использования NVIDIA runtime
    nvidia-ctk runtime configure --runtime=docker
    systemctl restart docker
    
    echo "NVIDIA Container Toolkit установлен"
else
    echo "NVIDIA GPU не обнаружена, пропускаем установку NVIDIA Container Toolkit"
fi

# Проверка GPU
echo "Проверка GPU..."
if command -v nvidia-smi &> /dev/null; then
    nvidia-smi
    echo "GPU доступна!"
else
    echo "GPU не обнаружена"
fi

# Создание директорий для проекта
echo "Создание директорий..."
mkdir -p /home/ubuntu/frame-segmentation/{data,outputs}
chown -R ubuntu:ubuntu /home/ubuntu/frame-segmentation

# Настройка окружения
echo "Настройка окружения..."
cat >> /home/ubuntu/.bashrc << 'EOF'
# Docker aliases
alias dps='docker ps'
alias dpsa='docker ps -a'
alias dimg='docker images'
alias dexec='docker exec -it'
alias dlogs='docker logs -f'

# Project directory
export PROJECT_DIR=/home/ubuntu/frame-segmentation
cd $PROJECT_DIR
EOF

# Создание скрипта для быстрого запуска обучения
cat > /home/ubuntu/start_training.sh << 'EOF'
#!/bin/bash
# Скрипт для запуска обучения

PROJECT_DIR=/home/ubuntu/frame-segmentation
cd $PROJECT_DIR

# Проверка наличия Docker образа
if ! docker images | grep -q "frame-seg:gpu"; then
    echo "Docker образ не найден. Сначала соберите образ:"
    echo "docker build --build-arg CUDA_VERSION=11.8.0 -t frame-seg:gpu ."
    exit 1
fi

# Запуск обучения
docker run --rm --gpus all \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/outputs:/app/outputs \
  frame-seg:gpu \
  python detectron/train.py \
    --coco-dir /app/data/coco \
    --output-dir /app/outputs \
    --epochs 100 \
    --batch-size 8 \
    --gpu
EOF

chmod +x /home/ubuntu/start_training.sh
chown ubuntu:ubuntu /home/ubuntu/start_training.sh

echo "=========================================="
echo "Настройка завершена!"
echo "=========================================="
echo ""
echo "Следующие шаги:"
echo "1. Подключитесь к серверу: ssh ubuntu@<IP>"
echo "2. Склонируйте репозиторий:"
echo "   cd ~/frame-segmentation"
echo "   git clone <your-repo-url> ."
echo "3. Соберите Docker образ:"
echo "   docker build --build-arg CUDA_VERSION=11.8.0 -t frame-seg:gpu ."
echo "4. Запустите обучение:"
echo "   ~/start_training.sh"
echo ""
echo "Или используйте полный пайплайн:"
echo "   docker run --rm --gpus all -v \$(pwd)/data:/app/data -v \$(pwd)/outputs:/app/outputs frame-seg:gpu bash -c '...'"